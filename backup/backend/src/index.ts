import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import compression from 'compression';
import morgan from 'morgan';
import rateLimit from 'express-rate-limit';
import dotenv from 'dotenv';
import { connectDB } from './config/database';
import { errorHandler } from './middleware/errorHandler';
import { syncService } from './services/syncService';
import { Category } from './models/Category';
import { fork } from 'child_process';
import path from 'path';
import http from 'http';
import { Server as SocketIOServer } from 'socket.io';

// Routes
import authRoutes from './routes/auth';
import productRoutes from './routes/products';
import categoryRoutes from './routes/categories';
import orderRoutes from './routes/orders';
import userRoutes from './routes/users';
import cartRoutes from './routes/cart';
import reviewRoutes from './routes/reviews';
import adminRoutes from './routes/admin';
import uploadRoutes from './routes/upload';
import deliveryRoutes from './routes/delivery';
import addressesRoutes from './routes/addresses';
import paymentMethodsRoutes from './routes/paymentMethods';
import characteristicsRoutes from './routes/characteristics';
import characteristicGroupsRoutes from './routes/characteristicGroups';
import cdekRoutes from './routes/cdek';
import notificationsRoutes from './routes/notifications';
import suppliersRoutes from './routes/suppliers';
import arrivalsRoutes from './routes/arrivals';
import receiptsRoutes from './routes/receipts';
import debtsRoutes from './routes/debts';
import paymentsRoutes from './routes/payments';
import clientsRoutes from './routes/clients';
import adminActionsRoutes from './routes/adminActions';
import sberRecipientsRoutes from './routes/sberRecipients';
import eventsRoutes from './routes/events';

dotenv.config();

const app = express();
const PORT = process.env.PORT || 5002;

// --- Socket.IO ---
const server = http.createServer(app);
export const io = new SocketIOServer(server, {
  cors: {
    origin: [
      process.env.FRONTEND_URL || 'http://localhost:3000',
      process.env.ADMIN_URL || 'http://localhost:3200',
      'http://localhost:3100',
      'http://localhost:3200',
      'http://localhost:3201',
      'http://localhost:3202',
      'http://localhost:3203',
      'http://localhost:50438', // vercel dev
      'https://*.vercel.app', // vercel production
      'https://*.railway.app', // railway
      'https://*.render.com', // render
      /^https:\/\/.*\.vercel\.app$/, // any vercel subdomain
      /^https:\/\/.*\.railway\.app$/, // any railway subdomain
      /^https:\/\/.*\.render\.com$/, // any render subdomain
      /^http:\/\/localhost:\d+$/, // any localhost port
      /^https:\/\/.*\.netlify\.app$/, // netlify
      /^https:\/\/.*\.netlify\.com$/, // netlify custom domains
      // Local network access (private IP ranges)
      /^http:\/\/192\.168\.\d+\.\d+:\d+$/, // 192.168.x.x network
      /^http:\/\/10\.\d+\.\d+\.\d+:\d+$/, // 10.x.x.x network
      /^http:\/\/172\.(1[6-9]|2[0-9]|3[0-1])\.\d+\.\d+:\d+$/, // 172.16-31.x.x network
      // Localtunnel domains
      'https://technoline.loca.lt',
      'https://technoline-admin.loca.lt',
      'https://technoline-api.loca.lt',
      /^https:\/\/.*\.loca\.lt$/, // any localtunnel subdomain
      /^https:\/\/.*\.loca\.it$/, // alternative localtunnel domain
      /^https:\/\/.*\.ngrok\.io$/, // ngrok domains
      /^https:\/\/.*\.ngrok-free\.app$/ // ngrok free domains
    ],
    credentials: true
  }
});

io.on('connection', (socket) => {
  console.log('üîå Socket.IO client connected:', socket.id);
  
  socket.on('joinOrderRoom', (orderId) => {
    socket.join(`order_${orderId}`);
    console.log(`üîå Socket ${socket.id} joined room order_${orderId}`);
  });
  
  socket.on('disconnect', () => {
    console.log('üîå Socket.IO client disconnected:', socket.id);
  });
  
  // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  socket.onAny((eventName, ...args) => {
    console.log(`üîå Socket event: ${eventName}`, args);
  });
  
  // –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
  console.log(`üîå Total connected clients: ${io.engine.clientsCount}`);
});

// Security middleware
app.use(helmet({
  crossOriginResourcePolicy: { policy: "cross-origin" },
  crossOriginOpenerPolicy: { policy: "unsafe-none" }
}));

// Handle preflight requests first
app.options('*', (req, res) => {
  const origin = req.headers.origin;
  console.log('üîÑ Preflight request from origin:', origin);
  
  res.header('Access-Control-Allow-Origin', origin || '*');
  res.header('Access-Control-Allow-Methods', 'GET,HEAD,PUT,PATCH,POST,DELETE,OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization, Cache-Control, Pragma, Expires');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.header('Access-Control-Max-Age', '86400');
  res.header('Access-Control-Expose-Headers', 'X-User-Role, X-Can-Edit');
  res.sendStatus(204);
});

app.use(cors({
  origin: function (origin, callback) {
    console.log('üåê CORS request from origin:', origin);
    callback(null, true); // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ origins –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
  allowedHeaders: [
    'Content-Type',
    'Authorization',
    'Accept',
    'Origin',
    'X-Requested-With',
    'Access-Control-Allow-Headers',
    'cache-control',
    'pragma',
    'expires'
  ],
  exposedHeaders: ['X-User-Role', 'X-Can-Edit'],
  preflightContinue: false,
  optionsSuccessStatus: 204
}));

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 1000, // limit each IP to 1000 requests per windowMs
  message: 'Too many requests from this IP, please try again later.'
});
// app.use('/api/', limiter);

// Body parsing middleware
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));

// Compression
app.use(compression());

// Logging
app.use(morgan('combined'));

// Static files middleware with CORS
app.use('/uploads', (req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
  res.header('Cross-Origin-Resource-Policy', 'cross-origin');
  res.header('Cross-Origin-Embedder-Policy', 'unsafe-none');
  next();
}, express.static('uploads'));

// Health check
app.get('/api/health', (req, res) => {
  res.status(200).json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});

// –û–¢–ö–õ–Æ–ß–ê–ï–ú ETag –∏ Last-Modified –¥–ª—è –≤—Å–µ—Ö —Ä–æ—É—Ç–æ–≤
app.set('etag', false);
app.use((req, res, next) => {
  res.removeHeader && res.removeHeader('Last-Modified');
  next();
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
app.use((req, res, next) => {
  console.log('>>> GLOBAL REQUEST', req.method, req.originalUrl, req.query);
  next();
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è auth —Ä–æ—É—Ç–æ–≤
app.use('/api/auth', (req, res, next) => {
  console.log('>>> AUTH REQUEST', req.method, req.originalUrl, req.body);
  next();
});

// API Routes
app.use('/api/auth', authRoutes);
app.use('/api/products', productRoutes);
app.use('/api/categories', categoryRoutes);
app.use('/api/orders', orderRoutes);
app.use('/api/users', userRoutes);
app.use('/api/cart', cartRoutes);
app.use('/api/reviews', reviewRoutes);
app.use('/api/admin', adminRoutes);
app.use('/api/upload', uploadRoutes);
app.use('/api/delivery', deliveryRoutes);
app.use('/api/addresses', addressesRoutes);
app.use('/api/payment-methods', paymentMethodsRoutes);
app.use('/api/characteristics', characteristicsRoutes);
app.use('/api/characteristic-groups', characteristicGroupsRoutes);
// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è /api/cdek/*
app.use('/api/cdek', (req, res, next) => {
  console.log('>>> GLOBAL /api/cdek/*', req.method, req.originalUrl, req.query);
  next();
});
app.use('/api/cdek', cdekRoutes);
app.use('/api/notifications', notificationsRoutes);
app.use('/api/suppliers', suppliersRoutes);
app.use('/api/arrivals', arrivalsRoutes);
app.use('/api/receipts', receiptsRoutes);
app.use('/api/debts', debtsRoutes);
app.use('/api/payments', paymentsRoutes);
app.use('/api/clients', clientsRoutes);
app.use('/api/admin-actions', adminActionsRoutes);
app.use('/api/sber-recipients', sberRecipientsRoutes);
app.use('/api/events', eventsRoutes);

// Error handling middleware
app.use(errorHandler);

// 404 handler
app.use('*', (req, res) => {
  res.status(404).json({ 
    message: 'Route not found',
    path: req.originalUrl 
  });
});

// –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
async function createInitialCategories() {
  try {
    const categories = [
      {
        name: '–ú–æ–±–∏–ª—å–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã',
        slug: 'mobilnye-telefony',
        description: '–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã –∏ –º–æ–±–∏–ª—å–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã',
        isActive: true,
        sortOrder: 1
      },
      {
        name: '–£–º–Ω—ã–µ –ß–∞—Å—ã',
        slug: 'umnye-chasy',
        description: '–°–º–∞—Ä—Ç-—á–∞—Å—ã –∏ —Ñ–∏—Ç–Ω–µ—Å-–±—Ä–∞—Å–ª–µ—Ç—ã',
        isActive: true,
        sortOrder: 2
      },
      {
        name: '–ù–æ—É—Ç–±—É–∫–∏ –∏ –ü–ª–∞–Ω—à–µ—Ç—ã',
        slug: 'noutbuki-i-planshety',
        description: '–ù–æ—É—Ç–±—É–∫–∏, –ø–ª–∞–Ω—à–µ—Ç—ã –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã',
        isActive: true,
        sortOrder: 3
      },
      {
        name: '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã',
        slug: 'aksessuary',
        description: '–ß–µ—Ö–ª—ã, –∑–∞—Ä—è–¥–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –¥—Ä—É–≥–∏–µ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã',
        isActive: true,
        sortOrder: 4
      },
      {
        name: '–ò–≥—Ä–æ–≤—ã–µ –ø—Ä–∏—Å—Ç–∞–≤–∫–∏',
        slug: 'igrovye-pristavki',
        description: '–ò–≥—Ä–æ–≤—ã–µ –∫–æ–Ω—Å–æ–ª–∏ –∏ –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã',
        isActive: true,
        sortOrder: 5
      },
      {
        name: '–ù–∞—É—à–Ω–∏–∫–∏ –∏ –ö–æ–ª–æ–Ω–∫–∏',
        slug: 'naushniki-i-kolonki',
        description: '–ù–∞—É—à–Ω–∏–∫–∏, –∫–æ–ª–æ–Ω–∫–∏ –∏ –∞—É–¥–∏–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ',
        isActive: true,
        sortOrder: 6
      },
      {
        name: '–¢–µ—Ö–Ω–∏–∫–∞ –¥–ª—è –î–æ–º–∞',
        slug: 'tehnika-dlya-doma',
        description: '–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –¥–ª—è –¥–æ–º–∞',
        isActive: true,
        sortOrder: 7
      },
      {
        name: '–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ',
        slug: 'kompyuternoe-oborudovanie',
        description: '–ö–æ–º–ø—å—é—Ç–µ—Ä—ã, –º–æ–Ω–∏—Ç–æ—Ä—ã –∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ',
        isActive: true,
        sortOrder: 8
      },
      {
        name: '–≠–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
        slug: 'elektrotransport',
        description: '–≠–ª–µ–∫—Ç—Ä–æ—Å–∞–º–æ–∫–∞—Ç—ã, –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –∏ –¥—Ä—É–≥–æ–π —ç–ª–µ–∫—Ç—Ä–æ—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
        isActive: true,
        sortOrder: 9
      }
    ];

    for (const categoryData of categories) {
      const existingCategory = await Category.findOne({ slug: categoryData.slug });
      if (!existingCategory) {
        const category = new Category(categoryData);
        await category.save();
        console.log(`‚úÖ Created category: ${categoryData.name}`);
      }
    }
    
    console.log('‚úÖ Initial categories setup completed');
  } catch (error) {
    console.error('‚ùå Error creating initial categories:', error);
  }
}

// Start server
const startServer = async () => {
  try {
    // Try to connect to database, but don't fail if it's not available
    await connectDB();
    
    // Create initial categories
    await createInitialCategories();

    // –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    fork(path.resolve(__dirname, '../../scripts/changelog-watcher.js'));
    
    const host = '0.0.0.0'; // –°–ª—É—à–∞–µ–º –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
    server.listen(Number(PORT), host, () => {
      console.log(`üöÄ Server running on port ${PORT}`);
      console.log(`üìä Health check: http://localhost:${PORT}/api/health`);
      console.log(`üîó API Base URL: http://localhost:${PORT}/api`);
      console.log(`üåê Network access: http://0.0.0.0:${PORT}/api`);
      console.log(`üåê Local network: http://192.168.50.69:${PORT}/api`);
    });
  } catch (error) {
    console.error('‚ùå Error starting server:', error);
    process.exit(1);
  }
};

startServer();