import React, { useState, useEffect } from 'react'
import { Table, Button, Space, Tag, Image, Modal, message, Form, Input, InputNumber, TreeSelect, Switch, Upload, Card, Typography, Spin } from 'antd'
import { PlusOutlined, EditOutlined, DeleteOutlined, EyeOutlined, UploadOutlined, SaveOutlined, CheckCircleOutlined } from '@ant-design/icons'
import { useQuery, useMutation, useQueryClient } from 'react-query'

interface Category {
  _id: string
  name: string
  slug: string
  parentId?: string
  children?: Category[]
}

interface Product {
  _id: string
  name: string
  slug: string
  price: number
  costPrice?: number
  comparePrice?: number
  sku?: string
  mainImage: string
  isActive: boolean
  inStock: boolean
  stockQuantity: number
  categoryId: {
    _id: string
    name: string
  }
  description?: string
  createdAt: string
  updatedAt: string
  images?: string[] // Added images property
}

const Products: React.FC = () => {
  const [isModalVisible, setIsModalVisible] = useState(false)
  const [editingProduct, setEditingProduct] = useState<Product | null>(null)
  const [imageUploading, setImageUploading] = useState(false)
  const [uploadedImageUrl, setUploadedImageUrl] = useState<string>('')
  const queryClient = useQueryClient()

  const [form] = Form.useForm();
  const [uploading, setUploading] = useState(false);
  const [imageUrl, setImageUrl] = useState<string | null>(null);
  const [fileList, setFileList] = useState<any[]>([]);
  const [previewVisible, setPreviewVisible] = useState(false);
  const [previewImage, setPreviewImage] = useState('');
  const [previewTitle, setPreviewTitle] = useState('');
  const [isSlugAutoGenerated, setIsSlugAutoGenerated] = useState(false);

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  const { data: categories } = useQuery<Category[]>('categories', async () => {
    const response = await fetch(`${import.meta.env.VITE_API_URL || 'http://localhost:5002/api'}/categories`)
    if (!response.ok) throw new Error('Failed to fetch categories')
    return response.json()
  })

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
  const { data: productsData, isLoading } = useQuery('products', async () => {
    const response = await fetch(`${import.meta.env.VITE_API_URL || 'http://localhost:5002/api'}/products`)
    if (!response.ok) throw new Error('Failed to fetch products')
    return response.json()
  })
  const products = productsData?.products || [];

  // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è TreeSelect
  const transformCategoriesToTreeData = (categories: Category[]): any[] => {
    return categories.map(category => ({
      title: category.name,
      value: category._id,
      key: category._id,
      children: category.children ? transformCategoriesToTreeData(category.children) : undefined
    }))
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const handleImageUpload = async (file: File) => {
    setImageUploading(true)
    const formData = new FormData()
    formData.append('image', file)

    try {
      const response = await fetch(`${import.meta.env.VITE_API_URL || 'http://localhost:5002/api'}/upload/image`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
        },
        body: formData
      })

      if (!response.ok) {
        throw new Error('Failed to upload image')
      }

      const result = await response.json()
      const imageUrl = result.file.url
      setUploadedImageUrl(imageUrl)
      message.success('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!')
      return false // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–≥—Ä—É–∑–∫—É
    } catch (error) {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è')
      console.error('Upload error:', error)
    } finally {
      setImageUploading(false)
    }
    return false
  }

  const handleCancel = () => setPreviewVisible(false);
  const handlePreview = async (file: any) => {
    setPreviewImage(file.url || file.thumbUrl || (file.response && file.response.file && file.response.file.url));
    setPreviewVisible(true);
    setPreviewTitle(file.name || (file.url && file.url.split('/').pop()));
  };
  const handleChange = ({ fileList: newFileList }: { fileList: any[] }) => {
    setFileList(newFileList);
    form.setFieldsValue({ images: newFileList });
  };

  const normFile = (e: any) => Array.isArray(e) ? e : e && e.fileList;

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ slug
  const generateSlug = (name: string): string => {
    return name
      .toLowerCase()
      .replace(/[–∞-—è—ë]/g, (char: string) => {
        const map: { [key: string]: string } = {
          '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'e',
          '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm',
          '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u',
          '—Ñ': 'f', '—Ö': 'h', '—Ü': 'c', '—á': 'ch', '—à': 'sh', '—â': 'sch',
          '—ä': '', '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya'
        };
        return map[char] || char;
      })
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .replace(/^-|-$/g, '');
  };

  // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
  const createProductMutation = useMutation({
    mutationFn: async (values: any) => {
      const productData = {
        ...values,
        mainImage: uploadedImageUrl || values.mainImage
      }
      
      const response = await fetch(`${import.meta.env.VITE_API_URL || 'http://localhost:5002/api'}/products`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
        },
        body: JSON.stringify(productData)
      })
      if (!response.ok) {
        throw new Error('Failed to create product')
      }
      return response.json()
    },
    onSuccess: () => {
      message.success('–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!')
      queryClient.invalidateQueries('products')
      setIsModalVisible(false)
      setEditingProduct(null)
      setUploadedImageUrl('')
    },
    onError: (error) => {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞')
      console.error('Create error:', error)
    }
  })

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
  const updateProductMutation = useMutation({
    mutationFn: async ({ id, values }: { id: string; values: any }) => {
      const productData = {
        ...values,
        mainImage: uploadedImageUrl || values.mainImage
      }
      
      const response = await fetch(`${import.meta.env.VITE_API_URL || 'http://localhost:5002/api'}/products/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
        },
        body: JSON.stringify(productData)
      })
      if (!response.ok) {
        throw new Error('Failed to update product')
      }
      return response.json()
    },
    onSuccess: () => {
      message.success('–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!')
      queryClient.invalidateQueries('products')
      setIsModalVisible(false)
      setEditingProduct(null)
      setUploadedImageUrl('')
    },
    onError: (error) => {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞')
      console.error('Update error:', error)
    }
  })

  // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
  const deleteProductMutation = useMutation({
    mutationFn: async (id: string) => {
      const response = await fetch(`${import.meta.env.VITE_API_URL || 'http://localhost:5002/api'}/products/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('admin_token')}`
        }
      })
      if (!response.ok) {
        throw new Error('Failed to delete product')
      }
      return response.json()
    },
    onSuccess: () => {
      message.success('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!')
      queryClient.invalidateQueries('products')
    },
    onError: (error) => {
      message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞')
      console.error('Delete error:', error)
    }
  })

  const handleCreate = () => {
    setEditingProduct(null)
    setUploadedImageUrl('')
    setImageUrl('')
    setFileList([])
    setIsSlugAutoGenerated(false)
    form.resetFields()
    form.setFieldsValue({ 
      images: [],
      slug: '', // –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–π slug
      isActive: true,
      inStock: true,
      stockQuantity: 0,
      price: 0,
      costPrice: 0
    }) // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Form –∏ fileList
    setIsModalVisible(true)
  }

  const handleEdit = (record: Product) => {
    setEditingProduct(record)
    setUploadedImageUrl(record.mainImage)
    setImageUrl(record.mainImage)
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º fileList –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    if (record.images && record.images.length > 0) {
      const initialFileList = record.images.map((url, index) => ({
        uid: `-${index}`,
        name: `image-${index}.jpg`,
        status: 'done' as const,
        url: url,
        response: { file: { url: url } }
      }));
      setFileList(initialFileList);
      form.setFieldsValue({ images: initialFileList }) // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Form –∏ fileList
    } else {
      setFileList([]);
      form.setFieldsValue({ images: [] }) // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Form –∏ fileList
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
    form.setFieldsValue({
      name: record.name,
      description: record.description,
      slug: record.slug,
      categoryId: record.categoryId._id,
      price: record.price,
      costPrice: record.costPrice,
      sku: record.sku,
      stockQuantity: record.stockQuantity,
      isActive: record.isActive,
      inStock: record.inStock,
      mainImage: record.mainImage
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ slug –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
    const autoGeneratedSlug = generateSlug(record.name);
    setIsSlugAutoGenerated(record.slug === autoGeneratedSlug);
    
    setIsModalVisible(true)
  }

  const handleDelete = (id: string) => {
    Modal.confirm({
      title: '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?',
      content: '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.',
      okText: '–î–∞',
      okType: 'danger',
      cancelText: '–ù–µ—Ç',
      onOk: () => deleteProductMutation.mutate(id)
    })
  }

  const handleModalOk = () => {
    const form = document.querySelector('form') as HTMLFormElement
    if (form) {
      form.dispatchEvent(new Event('submit', { bubbles: true }))
    }
  }

  const handleModalCancel = () => {
    setIsModalVisible(false)
    setEditingProduct(null)
    setUploadedImageUrl('')
    setImageUrl('')
    setFileList([])
    setIsSlugAutoGenerated(false)
    form.resetFields()
  }

  const onFinish = (values: any) => {
    const images = (values.images || [])
      .filter((f: any) => f.status === 'done')
      .map((f: any) => {
        const url = f.response?.file?.url || f.url;
        // –û—á–∏—â–∞–µ–º URL –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ?t=timestamp –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –±–∞–∑—É
        return url ? url.split('?')[0] : url;
      });
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º mainImage –∏–∑ —Ñ–æ—Ä–º—ã –∏–ª–∏ –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞
    const mainImage = values.mainImage || images[0] || '';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º slug, –µ—Å–ª–∏ –æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω
    let slug = values.slug;
    
    if (!slug || slug.trim() === '') {
      slug = generateSlug(values.name);
    }
    
    if (editingProduct) {
      updateProductMutation.mutate({ id: editingProduct._id, values: { ...values, slug, mainImage, images } })
    } else {
      createProductMutation.mutate({ ...values, slug, mainImage, images })
    }
  }

  const columns = [
    {
      title: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
      dataIndex: 'images',
      key: 'images',
      render: (_: any, record: any) => {
        const imageUrl = record.images?.[0] || record.mainImage;
        const fullImageUrl = imageUrl ? 
          (imageUrl.startsWith('http') ? imageUrl : `${import.meta.env.VITE_API_URL || 'http://localhost:5002'}${imageUrl}`) 
          : undefined;
        
        return (
          <Image 
            width={60} 
            src={fullImageUrl}
            onError={(e) => {
              console.error('Error loading table image:', fullImageUrl);
              e.currentTarget.style.display = 'none';
            }}
            onLoad={() => {
              console.log('Table image loaded successfully:', fullImageUrl);
            }}
          />
        );
      },
    },
    {
      title: '–ù–∞–∑–≤–∞–Ω–∏–µ',
      dataIndex: 'name',
      key: 'name',
      render: (text: string) => <strong>{text}</strong>
    },
    {
      title: 'Slug',
      dataIndex: 'slug',
      key: 'slug',
      render: (slug: string, record: Product) => {
        const autoGeneratedSlug = generateSlug(record.name);
        const isAutoGenerated = slug === autoGeneratedSlug;
        
        return (
          <span style={{ 
            color: !slug || slug === '' ? '#ff4d4f' : isAutoGenerated ? '#52c41a' : '#1890ff',
            fontFamily: 'monospace',
            fontSize: '12px',
            display: 'flex',
            alignItems: 'center',
            gap: '4px'
          }}>
            {slug || '–ù–ï –£–ö–ê–ó–ê–ù'}
            {isAutoGenerated && slug && (
              <span style={{ fontSize: '10px', color: '#52c41a' }} title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω">
                ‚úì
              </span>
            )}
          </span>
        )
      }
    },
    {
      title: '–¶–µ–Ω–∞',
      dataIndex: 'price',
      key: 'price',
      render: (price: number) => `‚ÇΩ${price.toLocaleString()}`
    },
    {
      title: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
      dataIndex: 'categoryId',
      key: 'categoryId',
      render: (category: any) => category?.name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
    },
    {
      title: '–°—Ç–∞—Ç—É—Å',
      key: 'status',
      render: (record: Product) => (
        <Space>
          {record.isActive ? (
            <Tag color="green">–ê–∫—Ç–∏–≤–µ–Ω</Tag>
          ) : (
            <Tag color="red">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</Tag>
          )}
          {record.inStock ? (
            <Tag color="blue">–í –Ω–∞–ª–∏—á–∏–∏</Tag>
          ) : (
            <Tag color="orange">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</Tag>
          )}
        </Space>
      )
    },
    {
      title: '–î–µ–π—Å—Ç–≤–∏—è',
      key: 'actions',
      render: (record: Product) => (
        <Space>
          <Button
            type="text"
            icon={<EyeOutlined />}
            onClick={() => {
              Modal.info({
                title: record.name,
                content: (
                  <div>
                    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {record.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                    <p><strong>–¶–µ–Ω–∞:</strong> ‚ÇΩ{record.price.toLocaleString()}</p>
                    <p><strong>–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏:</strong> ‚ÇΩ{record.costPrice?.toLocaleString() || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                    <p><strong>SKU:</strong> {record.sku || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p><strong>–û—Å—Ç–∞—Ç–æ–∫:</strong> {record.stockQuantity} —à—Ç.</p>
                    <p><strong>–°–æ–∑–¥–∞–Ω:</strong> {new Date(record.createdAt).toLocaleDateString()}</p>
                  </div>
                ),
                width: 600
              })
            }}
          />
          <Button
            type="text"
            icon={<EditOutlined />}
            onClick={() => handleEdit(record)}
          />
          <Button
            type="text"
            danger
            icon={<DeleteOutlined />}
            onClick={() => handleDelete(record._id)}
          />
          <Button
            type="text"
            icon={<EyeOutlined />}
            onClick={() => {
              const frontendUrl = 'http://localhost:3100';
              const productUrl = `${frontendUrl}/product/${record.slug}`;
              window.open(productUrl, '_blank');
            }}
            title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–∞–π—Ç–µ"
          />
        </Space>
      )
    }
  ]

  return (
    <div style={{ padding: '24px' }}>
      <Card>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
          <Typography.Title level={2} style={{ margin: 0 }}>
            –¢–æ–≤–∞—Ä—ã
          </Typography.Title>
          <Button
            type="primary"
            icon={<PlusOutlined />}
            onClick={handleCreate}
          >
            –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
          </Button>
        </div>

        <Table
          columns={columns}
          dataSource={products}
          rowKey="_id"
          loading={isLoading}
          pagination={{
            pageSize: 10,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total, range) => `${range[0]}-${range[1]} –∏–∑ ${total} —Ç–æ–≤–∞—Ä–æ–≤`
          }}
        />
      </Card>

      <Modal
        title={editingProduct ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä'}
        open={isModalVisible}
        onOk={handleModalOk}
        onCancel={handleModalCancel}
        width={800}
        okText={editingProduct ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'}
        cancelText="–û—Ç–º–µ–Ω–∞"
        confirmLoading={createProductMutation.isLoading || updateProductMutation.isLoading}
      >
        <Form
          layout="vertical"
          onFinish={onFinish}
          initialValues={editingProduct || {
            isActive: true,
            inStock: true,
            stockQuantity: 0,
            price: 0,
            costPrice: 0
          }}
          form={form}
        >
          <Form.Item
            name="name"
            label="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"
            rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞' }]}
          >
            <Input 
              placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"
              onChange={(e) => {
                const slug = form.getFieldValue('slug');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º slug —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª–µ slug –ø—É—Å—Ç–æ–µ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–≤–æ–¥–∏–ª –µ–≥–æ –≤—Ä—É—á–Ω—É—é
                if (!slug || slug === '' || isSlugAutoGenerated) {
                  const generatedSlug = generateSlug(e.target.value);
                  form.setFieldsValue({ slug: generatedSlug });
                  setIsSlugAutoGenerated(true);
                }
              }}
              onBlur={(e) => {
                // –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ —Ç–∞–∫–∂–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º slug, –µ—Å–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π
                const slug = form.getFieldValue('slug');
                const name = e.target.value;
                if ((!slug || slug === '') && name) {
                  const generatedSlug = generateSlug(name);
                  form.setFieldsValue({ slug: generatedSlug });
                  setIsSlugAutoGenerated(true);
                }
              }}
            />
          </Form.Item>

          <Form.Item
            name="description"
            label="–û–ø–∏—Å–∞–Ω–∏–µ"
            rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞' }]}
          >
            <Input.TextArea rows={4} placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" />
          </Form.Item>

          <Form.Item
            name="slug"
            label="Slug (URL)"
            rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ slug –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏' }]}
          >
            <Input 
              placeholder="–í–≤–µ–¥–∏—Ç–µ slug –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"
              onChange={(e) => {
                const name = form.getFieldValue('name');
                if (!e.target.value && name) {
                  const generatedSlug = generateSlug(name);
                  form.setFieldsValue({ slug: generatedSlug });
                  setIsSlugAutoGenerated(true);
                } else {
                  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª slug –≤—Ä—É—á–Ω—É—é, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
                  setIsSlugAutoGenerated(false);
                }
              }}
              addonAfter={
                <Button 
                  type="text" 
                  size="small"
                  onClick={() => {
                    const name = form.getFieldValue('name');
                    if (name) {
                      const generatedSlug = generateSlug(name);
                      form.setFieldsValue({ slug: generatedSlug });
                      setIsSlugAutoGenerated(true);
                      message.success('Slug —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
                    } else {
                      message.warning('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
                    }
                  }}
                  title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å slug –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
                >
                  üîÑ
                </Button>
              }
              suffix={
                isSlugAutoGenerated ? (
                  <span style={{ fontSize: '12px', color: '#52c41a' }}>
                    ‚úì –ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
                  </span>
                ) : (
                  <span style={{ fontSize: '12px', color: '#999' }}>
                    –†—É—á–Ω–æ–π –≤–≤–æ–¥
                  </span>
                )
              }
            />
          </Form.Item>

          <Form.Item
            name="categoryId"
            label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è"
            rules={[{ required: true, message: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é' }]}
          >
            <TreeSelect
              placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"
              treeData={categories ? transformCategoriesToTreeData(categories) : []}
              treeDefaultExpandAll={false}
              allowClear
              showSearch
              treeNodeFilterProp="title"
            />
          </Form.Item>

                      <Form.Item
              name="price"
              label="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏"
              rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É' }]}
            >
              <InputNumber
                style={{ width: '100%' }}
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É"
                min={0}
                formatter={value => `‚ÇΩ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                parser={(value: string | undefined) => value ? Number(value.replace(/\‚ÇΩ\s?|(,*)/g, '')) : 0}
              />
            </Form.Item>

                      <Form.Item
              name="costPrice"
              label="–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏"
            >
              <InputNumber
                style={{ width: '100%' }}
                placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –∑–∞–∫—É–ø–∫–∏"
                min={0}
                formatter={value => `‚ÇΩ ${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ',')}
                parser={(value: string | undefined) => value ? Number(value.replace(/\‚ÇΩ\s?|(,*)/g, '')) : 0}
              />
            </Form.Item>

          <Form.Item
            name="sku"
            label="SKU (–∞—Ä—Ç–∏–∫—É–ª)"
          >
            <Input placeholder="–í–≤–µ–¥–∏—Ç–µ SKU" />
          </Form.Item>

          <Form.Item
            name="stockQuantity"
            label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ"
            rules={[{ required: true, message: '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ' }]}
          >
            <InputNumber
              style={{ width: '100%' }}
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"
              min={0}
            />
          </Form.Item>

          <Form.Item
            name="mainImage"
            label="–ì–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"
          >
            <Upload
              name="image"
              action={`${import.meta.env.VITE_API_URL || 'http://localhost:5002/api'}/upload/image`}
              showUploadList={false}
              headers={{
                Authorization: `Bearer ${localStorage.getItem('admin_token')}`,
              }}
              beforeUpload={file => {
                const isJpgOrPng = file.type === 'image/jpeg' || file.type === 'image/png';
                if (!isJpgOrPng) {
                  message.error('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ JPG/PNG —Ñ–∞–π–ª—ã!');
                  return Upload.LIST_IGNORE;
                }
                const isLt2M = file.size / 1024 / 1024 < 2;
                if (!isLt2M) {
                  message.error('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ 2MB!');
                  return Upload.LIST_IGNORE;
                }
                return true;
              }}
              onChange={info => {
                if (info.file.status === 'uploading') {
                  setUploading(true);
                }
                if (info.file.status === 'done') {
                  setUploading(false);
                  if (info.file.response && info.file.response.file && info.file.response.file.url) {
                    const imageUrl = info.file.response.file.url;
                    form.setFieldsValue({ mainImage: imageUrl });
                    setImageUrl(imageUrl);
                    message.success('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!');
                  } else {
                    message.error('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                  }
                } else if (info.file.status === 'error') {
                  setUploading(false);
                  message.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                }
              }}
            >
              {uploading ? <Spin /> : imageUrl ? (
                <div style={{ position: 'relative', display: 'inline-block' }}>
                  <img 
                    src={imageUrl.startsWith('http') ? imageUrl : `${import.meta.env.VITE_API_URL || 'http://localhost:5002'}${imageUrl}`}
                    alt="main" 
                    style={{ width: 100, borderRadius: 8, border: '1px solid #eee' }}
                    onError={(e) => {
                      console.error('Error loading image:', imageUrl);
                      e.currentTarget.style.display = 'none';
                    }}
                    onLoad={() => {
                      console.log('Image loaded successfully:', imageUrl);
                    }}
                  />
                  <CheckCircleOutlined style={{ color: 'green', position: 'absolute', top: 4, right: 4, fontSize: 24, background: '#fff', borderRadius: '50%' }} />
                </div>
              ) : (
                <Button icon={<UploadOutlined />}>–ó–∞–≥—Ä—É–∑–∏—Ç—å</Button>
              )}
            </Upload>
          </Form.Item>

          <Form.Item
            name="images"
            label="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"
            valuePropName="fileList"
            getValueFromEvent={normFile}
            rules={[{ 
              validator: (_, value) => {
                if (!value || value.length === 0) {
                  return Promise.reject(new Error('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                }
                const doneFiles = value.filter((f: any) => f.status === 'done');
                if (doneFiles.length === 0) {
                  return Promise.reject(new Error('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                }
                return Promise.resolve();
              }
            }]}
          >
            <Upload
              name="image"
              action={`${import.meta.env.VITE_API_URL || 'http://localhost:5002/api'}/upload/image`}
              listType="picture-card"
              multiple
              maxCount={10}
              fileList={fileList}
              onPreview={handlePreview}
              onChange={handleChange}
              headers={{ Authorization: `Bearer ${localStorage.getItem('admin_token')}` }}
              showUploadList={{ showPreviewIcon: true, showRemoveIcon: true }}
            >
              {fileList.length >= 10 ? null : <div><PlusOutlined /><div>–ó–∞–≥—Ä—É–∑–∏—Ç—å</div></div>}
            </Upload>
            <Modal open={previewVisible} title={previewTitle} footer={null} onCancel={handleCancel}>
              <img 
                alt="example" 
                style={{ width: '100%' }} 
                src={previewImage.startsWith('http') ? previewImage : `${import.meta.env.VITE_API_URL || 'http://localhost:5002'}${previewImage}`}
                onError={(e) => {
                  console.error('Error loading preview image:', previewImage);
                  e.currentTarget.style.display = 'none';
                }}
                onLoad={() => {
                  console.log('Preview image loaded successfully:', previewImage);
                }}
              />
            </Modal>
          </Form.Item>

          <Form.Item
            name="isActive"
            label="–ê–∫—Ç–∏–≤–µ–Ω"
            valuePropName="checked"
          >
            <Switch />
          </Form.Item>

          <Form.Item
            name="inStock"
            label="–í –Ω–∞–ª–∏—á–∏–∏"
            valuePropName="checked"
          >
            <Switch />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  )
}

export default Products 