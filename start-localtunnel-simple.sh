#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ —Å–µ—Ä–≤–∏—Å—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."

if ! curl -s "http://localhost:5002/health" > /dev/null; then
    echo "‚ùå –°–µ—Ä–≤–∏—Å—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã! –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ ./start-all.sh"
    exit 1
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—É–Ω–Ω–µ–ª–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f "lt --port" 2>/dev/null || true
pkill -f "vite" 2>/dev/null || true
sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ localtunnel
if ! command -v lt &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º localtunnel..."
    npm install -g localtunnel
fi

# –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å —Ç—É–Ω–Ω–µ–ª—è
echo "üîë –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å —Ç—É–Ω–Ω–µ–ª—è..."
TUNNEL_PASSWORD=$(curl -s https://loca.lt/mytunnelpassword)
echo "‚úÖ –ü–∞—Ä–æ–ª—å —Ç—É–Ω–Ω–µ–ª—è: $TUNNEL_PASSWORD"
echo "‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å, –æ–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç—É–Ω–Ω–µ–ª—è–º"
echo ""

echo "üåç –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª–∏..."

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—É–Ω–Ω–µ–ª–∏ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–¥–¥–æ–º–µ–Ω–∞–º–∏
echo "üì° API (5002)..."
lt --port 5002 --subdomain technoline-api --local-host localhost &
LT_API_PID=$!
sleep 2

echo "üåê Frontend (3100)..."
lt --port 3100 --subdomain technoline-store --local-host localhost &
LT_FRONTEND_PID=$!
sleep 2

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω–∫—É —Å —Ç—É–Ω–Ω–µ–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
echo "‚öôÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∞–¥–º–∏–Ω–∫–∏ —Å —Ç—É–Ω–Ω–µ–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏..."
cd admin
VITE_TUNNEL=true VITE_API_URL="https://technoline-api.loca.lt" npm run dev -- --host &
ADMIN_PID=$!
cd ..
sleep 2

echo "‚öôÔ∏è –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–∫–∏..."
lt --port 3200 --subdomain technoline-admin --local-host localhost &
LT_ADMIN_PID=$!
sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç—É–Ω–Ω–µ–ª–∏ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å
sleep 3
if ! ps -p $LT_API_PID > /dev/null; then
    echo "‚ùå –¢—É–Ω–Ω–µ–ª—å API –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

if ! ps -p $LT_FRONTEND_PID > /dev/null; then
    echo "‚ùå –¢—É–Ω–Ω–µ–ª—å Frontend –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

if ! ps -p $LT_ADMIN_PID > /dev/null; then
    echo "‚ùå –¢—É–Ω–Ω–µ–ª—å Admin –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

if ! ps -p $ADMIN_PID > /dev/null; then
    echo "‚ùå –ê–¥–º–∏–Ω–∫–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—å"
    exit 1
fi

echo ""
echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏ —Ç—É–Ω–Ω–µ–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã!"
echo "üìù URLs:"
echo "API:      https://technoline-api.loca.lt"
echo "Frontend: https://technoline-store.loca.lt"
echo "Admin:    https://technoline-admin.loca.lt"
echo ""
echo "üîë –ü–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞: $TUNNEL_PASSWORD"
echo ""
echo "‚ö†Ô∏è –í–∞–∂–Ω–æ:"
echo "1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç—É–Ω–Ω–µ–ª—é"
echo "2. –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: pkill -f 'lt --port' && pkill -f 'vite'"
echo "3. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:"
echo "   - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã"
echo "   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∑–∞–Ω–æ–≤–æ"
echo ""
echo "‚ùå –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
cleanup() {
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    pkill -f "lt --port"
    pkill -f "vite"
    echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

# –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap cleanup SIGINT SIGTERM

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
wait 