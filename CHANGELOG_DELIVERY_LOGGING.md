# Система логирования изменений доставки

## Проблема

Ранее изменения в доставках не записывались в список изменений (changelog), потому что система `changelog-watcher.js` отслеживала только изменения в файлах исходного кода, а не изменения в базе данных или API запросы.

## Решение

Добавлена система логирования изменений доставки и заказов, которая записывает все важные события в файл `admin/public/ai-changelog.json`.

## Типы логируемых изменений

### 1. Изменения доставки CDEK (`delivery_change`)

**Тип:** `cdek_delivery`

**Действия:**
- `delivery_dates_request` - запрос дат доставки
- `delivery_dates_success` - успешное получение дат доставки
- `delivery_dates_error` - ошибка при получении дат доставки
- `pvz_list_request` - запрос списка ПВЗ
- `pvz_list_success` - успешное получение списка ПВЗ
- `pvz_list_empty` - отсутствие ПВЗ в городе
- `pvz_list_error` - ошибка при получении списка ПВЗ

**Пример записи:**
```json
{
  "timestamp": "2025-07-15T23:03:01.408Z",
  "action": "delivery_change",
  "type": "cdek_delivery",
  "delivery_action": "pvz_list_success",
  "details": {
    "address": "Павловский посад",
    "city_code": "488",
    "fias_guid": "bb464d94-30bf-4cf8-a320-905733fa67e2",
    "pvz_count": 4,
    "pvz_codes": ["PPS3", "PPS4", "PPS2", "PPS6"]
  },
  "description": "Изменение доставки CDEK: pvz_list_success"
}
```

### 2. Изменения заказов (`order_change`)

**Тип:** `order_management`

**Действия:**
- `order_created` - создание нового заказа
- `order_creation_error` - ошибка при создании заказа
- `order_status_updated` - обновление статуса заказа
- `order_not_found` - попытка обновления несуществующего заказа
- `order_update_error` - ошибка при обновлении заказа

**Пример записи:**
```json
{
  "timestamp": "2025-07-15T23:03:01.410Z",
  "action": "order_change",
  "type": "order_management",
  "order_action": "order_status_updated",
  "details": {
    "order_id": "64f5a1b2c3d4e5f6a7b8c9d0",
    "order_number": "ORD-2025-001",
    "old_status": "pending",
    "new_status": "confirmed",
    "old_tracking_number": null,
    "new_tracking_number": "CDEK123456789",
    "admin_user_id": "64f5a1b2c3d4e5f6a7b8c9d1",
    "admin_role": "admin"
  },
  "description": "Изменение заказа: order_status_updated"
}
```

## Файлы с логированием

### 1. `backend/src/routes/cdek.ts`
- Функция `logDeliveryChange()` для логирования изменений доставки
- Логирование в эндпоинтах:
  - `GET /api/cdek/delivery-dates`
  - `GET /api/cdek/pvz-list`

### 2. `backend/src/routes/orders.ts`
- Функция `logOrderChange()` для логирования изменений заказов
- Логирование в эндпоинтах:
  - `POST /api/orders` (создание заказа)
  - `PUT /api/orders/:id/status` (обновление статуса)

### 3. `backend/src/test-changelog.ts`
- Тестовые функции для проверки логирования
- `testDeliveryLogging()` - тест логирования доставки
- `testOrderLogging()` - тест логирования заказов

## Как это работает

1. **При выполнении действий** (запрос ПВЗ, создание заказа, обновление статуса) вызывается соответствующая функция логирования
2. **Функция логирования** создает запись с метаданными и сохраняет в `ai-changelog.json`
3. **Changelog-watcher** может перезаписывать файл, поэтому важно не запускать его одновременно с тестированием
4. **Записи сохраняются** в формате JSON с временными метками и детальной информацией

## Просмотр изменений

Изменения можно просматривать в админ-панели на странице "История изменений" (`/change-history`), где они будут отображаться вместе с изменениями файлов.

## Тестирование

Для тестирования логирования:

```bash
cd backend
npx ts-node src/test-changelog.ts
```

Это добавит тестовые записи в changelog.

## Важные моменты

1. **Changelog-watcher конфликт**: Если запущен `changelog-watcher.js`, он может перезаписывать файл и удалять записи логирования
2. **Путь к файлу**: Используется относительный путь `../admin/public/ai-changelog.json` от папки backend
3. **Ограничение записей**: Сохраняется только последние 100 записей
4. **Обработка ошибок**: Все функции логирования обернуты в try-catch для предотвращения сбоев

## Будущие улучшения

1. Добавить логирование изменений в других частях системы (пользователи, товары)
2. Создать отдельный файл для логов доставки
3. Добавить фильтрацию по типам изменений в админ-панели
4. Реализовать уведомления о критических изменениях 